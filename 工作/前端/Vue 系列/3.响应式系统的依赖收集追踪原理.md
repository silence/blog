### å“åº”å¼ç³»ç»Ÿçš„ä¾èµ–æ”¶é›†è¿½è¸ªåŸç†

#### ä¸ºä»€ä¹ˆè¦ä¾èµ–æ”¶é›†ï¼Ÿ

**å…ˆä¸¾ä¸ªæ —å­ğŸŒ°**

æˆ‘ä»¬ç°åœ¨æœ‰è¿™ä¹ˆä¸€ä¸ª Vue å¯¹è±¡ã€‚

```javascript
new Vue({
    template: 
        `<div>
            <span>{{text1}}</span> 
            <span>{{text2}}</span> 
        <div>`,
    data: {
        text1: 'text1',
        text2: 'text2',
        text3: 'text3'
    }
});
```

ç„¶åæˆ‘ä»¬åšäº†è¿™ä¹ˆä¸€ä¸ªæ“ä½œã€‚

```javascript
this.text3 = 'modify text3';
```

æˆ‘ä»¬ä¿®æ”¹äº† data ä¸­ text3 çš„æ•°æ®ï¼Œä½†æ˜¯å› ä¸ºè§†å›¾ä¸­å¹¶ä¸éœ€è¦ç”¨åˆ° text3ï¼Œæ‰€ä»¥æˆ‘ä»¬å¹¶ä¸éœ€è¦è§¦å‘ä¸Šä¸€ç« æ‰€è®²çš„ cb å‡½æ•°æ¥æ›´æ–°è§†å›¾ï¼Œè°ƒç”¨ cb æ˜¾ç„¶æ˜¯ä¸æ­£ç¡®çš„ã€‚

**å†æ¥ä¸€ä¸ªæ —å­ğŸŒ°**

å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šåœ¨å¤šä¸ª Vue å¯¹è±¡ä¸­ç”¨åˆ°å®ƒè¿›è¡Œå±•ç¤ºã€‚

```javascript
let globalObj = {
    text1: 'text1'
};

let o1 = new Vue({
    template:
        `<div>
            <span>{{text1}}</span> 
        <div>`,
    data: globalObj
});

let o2 = new Vue({
    template:
        `<div>
            <span>{{text1}}</span> 
        <div>`,
    data: globalObj
});
```

è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬æ‰§è¡Œäº†å¦‚ä¸‹æ“ä½œã€‚

```javascript
globalObj.text1 = 'hello, text1';
```

æˆ‘ä»¬éœ€è¦é€šçŸ¥ o1 ä»¥åŠ o2 ä¸¤ä¸ª vm å®ä¾‹è¿›è¡Œè§†å›¾çš„æ›´æ–°ï¼Œä¾èµ–æ”¶é›†ä¼šè®© text1 è¿™ä¸ªæ•°æ®çŸ¥é“ â€œå“¦ ~ æœ‰ä¸¤ä¸ªåœ°æ–¹ä¾èµ–æˆ‘çš„æ•°æ®ï¼Œæˆ‘å˜åŒ–çš„æ—¶å€™éœ€è¦é€šçŸ¥å®ƒä»¬ ~ â€ã€‚

æœ€ç»ˆä¼šå½¢æˆæ•°æ®ä¸è§†å›¾çš„ä¸€ç§å¯¹åº”å…³ç³»ï¼Œå¦‚ä¸‹å›¾ã€‚

![image-20210524195242471](https://raw.githubusercontent.com/silence/blog/assets/assets/20210524195242.png)

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹ **ä¾èµ–æ”¶é›†** æ˜¯å¦‚ä½•å®ç°çš„ã€‚

#### è®¢é˜…è€… Dep

é¦–å…ˆæˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªè®¢é˜…è€… Depï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ç”¨æ¥å­˜æ”¾ Watcher è§‚å¯Ÿè€…å¯¹è±¡ã€‚

```javascript
class Dep {
  constructor () {
    /** ç”¨æ¥å­˜æ”¾ Watcher å¯¹è±¡çš„æ•°ç»„ */
    this.subs = []
  }
  
  /** åœ¨ subs ä¸­æ·»åŠ ä¸€ä¸ª Watcher å¯¹è±¡ */
  addSub (sub) {
    this.subs.push(sub);
  }
  
  /** é€šçŸ¥æ‰€æœ‰ Watcher å¯¹è±¡æ›´æ–°è§†å›¾ */
  notify () {
    this.subs.forEach((sub) => {
      sub.update();
    })
  }
}
```

ä¸ºäº†ä¾¿äºç†è§£æˆ‘ä»¬åªå®ç°äº†æ·»åŠ çš„éƒ¨åˆ†ä»£ç ï¼Œä¸»è¦æ˜¯ä¸¤ä»¶äº‹æƒ…ï¼š

1. ç”¨ addSub æ–¹æ³•å¯ä»¥åœ¨ç›®å‰çš„ Dep å¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ª Watcher çš„è®¢é˜…æ“ä½œï¼›
2. ç”¨ notify æ–¹æ³•é€šçŸ¥ç›®å‰ Dep å¯¹è±¡çš„ subs ä¸­çš„æ‰€æœ‰ Watcher å¯¹è±¡è§¦å‘æ›´æ–°æ“ä½œã€‚

#### è§‚å¯Ÿè€… Watcher 

```javascript
class Watcher  {
  constructor () {
    /** åœ¨ new ä¸€ä¸ª Watcher å¯¹è±¡æ—¶å°†è¯¥å¯¹è±¡èµ‹å€¼ç»™ Dep.targetï¼Œåœ¨ get ä¸­ä¼šç”¨åˆ° */
    Dep.target = this;
  }
  
  /** æ›´æ–°è§†å›¾çš„æ–¹æ³• */
  update () {
    console.log("è§†å›¾æ›´æ–°å•¦ ~");
  }
}

Dep.target = null;
```

#### ä¾èµ–æ”¶é›†

æ¥ä¸‹æ¥æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ defineReactive ä»¥åŠæ„é€ å‡½æ•°ï¼Œæ¥å®Œæˆä¾èµ–æ”¶é›†ã€‚

æˆ‘ä»¬åœ¨é—­åŒ…ä¸­å¢åŠ äº†ä¸€ä¸ª Dep ç±»å¯¹è±¡ï¼Œç”¨æ¥æ”¶é›† Watcher å¯¹è±¡ã€‚åœ¨å¯¹è±¡è¢« **è¯»** çš„æ—¶å€™ï¼Œä¼šè§¦å‘ reactiveGetter å‡½æ•°æŠŠå½“å‰çš„ Watcher å¯¹è±¡ï¼ˆå­˜æ”¾åœ¨ Dep.target ä¸­ï¼‰æ”¶é›†åˆ° Dep ç±»ä¸­å»ã€‚ä¹‹åå¦‚æœå½“è¯¥å¯¹è±¡è¢« **å†™** çš„æ—¶å€™ï¼Œåˆ™ä¼šè§¦å‘ reactiveSetter æ–¹æ³•ï¼Œé€šçŸ¥ Dep ç±»è°ƒç”¨ notify æ¥è§¦å‘æ‰€æœ‰ Watcher å¯¹è±¡çš„ update æ–¹æ³•æ›´æ–°å¯¹åº”è§†å›¾ã€‚

```javascript
function defineReactive (obj, key, val) {
  /** ä¸€ä¸ª Dep ç±»å¯¹è±¡ */
  const dep = new Dep();
  
  Object.defineProperty(obj, key, {
    enumerable: true, 
    configurable: true,
    get: function reactiveGetter () {
      /** å°† Dep.targetï¼ˆå³å½“å‰çš„ Watcher å¯¹è±¡å­˜å…¥ dep çš„ subs ä¸­ï¼‰ */
      dep.addSub(Dep.target);
      return val;
    },
    set: function reactiveSetter (newVal) {
      if (newVal === val) return ;
      /** åœ¨ set çš„æ—¶å€™è§¦å‘ dep çš„ notify æ¥é€šçŸ¥æ‰€æœ‰çš„ Watcher å¯¹è±¡æ›´æ–°è§†å›¾ */
      dep.notify();
    }
  })
}

class Vue {
  constructor(options) {
    this._data = options.data;
    observer(this._data);
    /** æ–°å»ºä¸€ä¸ª Watcher è§‚å¯Ÿè€…å¯¹è±¡ï¼Œè¿™æ—¶å€™ Dep.target ä¼šæŒ‡å‘è¿™ä¸ª Watcher å¯¹è±¡ */
    new Watcher();
    /** åœ¨è¿™é‡Œæ¨¡æ‹Ÿ render çš„è¿‡ç¨‹ï¼Œä¸ºäº†è§¦å‘ test å±æ€§çš„ get å‡½æ•° */
    console.log('render ~', this._data.test);
  }
}
```

#### å°ç»“

æ€»ç»“ä¸€ä¸‹

é¦–å…ˆåœ¨ observer çš„è¿‡ç¨‹ä¸­ä¼šæ³¨å†Œ get æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨æ¥è¿›è¡Œ **ä¾èµ–æ”¶é›†**ã€‚åœ¨å®ƒçš„é—­åŒ…ä¸­ä¼šæœ‰ä¸€ä¸ª Dep å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ç”¨æ¥å­˜æ”¾ Watcher å¯¹è±¡çš„å®ä¾‹ã€‚å…¶å® **ä¾èµ–æ”¶é›†** çš„è¿‡ç¨‹å°±æ˜¯æŠŠ Watcher å®ä¾‹å­˜æ”¾åˆ°å¯¹åº”çš„ Dep å¯¹è±¡ä¸­å»ã€‚get æ–¹æ³•å¯ä»¥è®©å½“å‰çš„ Watcher å¯¹è±¡ï¼ˆDep.targetï¼‰å­˜æ”¾åˆ°å®ƒçš„ subs ä¸­ï¼ˆ addSub ï¼‰æ–¹æ³•ã€‚ åœ¨æ•°æ®å˜åŒ–æ—¶ï¼Œset ä¼šè°ƒç”¨ Dep å¯¹è±¡çš„ notify æ–¹æ³•é€šçŸ¥å®ƒå†…éƒ¨æ‰€æœ‰çš„ Watcher å¯¹è±¡è¿›è¡Œè§†å›¾æ›´æ–°ã€‚

è¿™æ˜¯ Object.defineProperty çš„ `set/get` æ–¹æ³•å¤„ç†çš„äº‹æƒ…ï¼Œé‚£ä¹ˆ **ä¾èµ–æ”¶é›†** çš„å‰ææ¡ä»¶è¿˜æœ‰ä¸¤ä¸ªï¼š

1. è§¦å‘ get æ–¹æ³•ï¼›
2. æ–°å»ºä¸€ä¸ª Watcher å¯¹è±¡ã€‚

è¿™ä¸ªæˆ‘ä»¬åœ¨ Vue çš„æ„é€ ç±»ä¸­å¤„ç†ã€‚æ–°å»ºä¸€ä¸ª Watcher å¯¹è±¡åªéœ€è¦ new å‡ºæ¥ï¼Œè¿™æ—¶å€™ Dep.target å·²ç»æŒ‡å‘äº†è¿™ä¸ª new å‡ºæ¥çš„ Watcher å¯¹è±¡æ¥ã€‚**è€Œè§¦å‘ get æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå®é™…ä¸Šåªè¦æŠŠ render function è¿›è¡Œæ¸²æŸ“ï¼Œé‚£ä¹ˆå…¶ä¸­çš„ä¾èµ–çš„å¯¹è±¡éƒ½ä¼šè¢«è¯»å–ã€‚**è¿™é‡Œæˆ‘ä»¬é€šè¿‡æ‰“å°æ¥æ¨¡æ‹Ÿè¿™ä¸ªè¿‡ç¨‹ï¼Œè¯»å– test æ¥è§¦å‘ get è¿›è¡Œä¾èµ–æ”¶é›†ã€‚

æœ¬ç« æˆ‘ä»¬ä»‹ç»äº†**ä¾èµ–æ”¶é›†**çš„è¿‡ç¨‹ï¼Œé…åˆä¹‹å‰çš„å“åº”å¼åŸç†ï¼Œå·²ç»æŠŠæ•´ä¸ªå“åº”å¼ç³»ç»Ÿä»‹ç»å®Œæ¯•äº†ã€‚

**å…¶ä¸»è¦å°±æ˜¯ get è¿›è¡Œ ä¾èµ–æ”¶é›†ã€‚set é€šè¿‡è§‚å¯Ÿè€…æ¥æ›´æ–°è§†å›¾ï¼Œ**é…åˆä¸‹å›¾ä»”ç»†æ‹ä¸€æ‹ï¼Œç›¸ä¿¡ä¸€å®šèƒ½ææ‡‚å®ƒï¼

![image-20210524211005484](https://raw.githubusercontent.com/silence/blog/assets/assets/20210524211005.png)

